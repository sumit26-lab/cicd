name: Deploy FastAPI App

on:
  push:
    branches:
      - main   # ðŸ‘ˆ triggers only when you push to the 'main' branch

jobs:
  deploy:
    name: Deploy to Ubuntu VM
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------
      # Step 1: Checkout latest code (required for GitHub context)
      # --------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Step 2: Setup SSH agent using private key stored in secrets
      # --------------------------------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --------------------------------------------------------
      # Step 3: Deploy FastAPI App to Ubuntu VM
      # --------------------------------------------------------
      - name: Deploy FastAPI to VM
        run: |
          ssh -o StrictHostKeyChecking=no ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} << 'EOF'
            set -e  # Exit immediately if a command fails
            echo "ðŸš€ Starting deployment on server..."

            # Define paths and repo info
            BASE_PATH=${{ secrets.PROJECT_PATH }}         # e.g., /home/azureuser
            PROJECT_DIR="$BASE_PATH/cicd"
            echo "Base path is: $BASE_PATH"
            echo "Project directory is: $PROJECT_DIR"
            REPO_URL="https://github.com/mohneeshchoudhary/cicd.git"

            # --------------------------------------------------------
            # Check if repo folder exists
            # --------------------------------------------------------
            if [ -d "$PROJECT_DIR/.git" ]; then
              echo "ðŸ“‚ Project already exists. Pulling latest changes..."
              cd "$PROJECT_DIR"
              git fetch origin main
              git reset --hard origin/main
            else
              echo "ðŸ†• Project not found. Cloning fresh repository..."
              cd "$BASE_PATH"
              git clone $REPO_URL cicd
              cd cicd
            fi
            
            # ---------------------------------------------------------
               # Install python3-venv package if not already installed
            # ----------------------------------------------------------
              sudo apt-get upadte 
              sudo apt-get install -y python3.12-venv  
               


            # --------------------------------------------------------
            # Create or activate virtual environment and install dependencies
            # --------------------------------------------------------
            echo "ðŸ“¦ Setting up Python environment..."
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # --------------------------------------------------------
            # Load environment variables (if .env exists)
            # --------------------------------------------------------
            if [ -f ".env" ]; then
              echo "ðŸ” Loading environment variables..."
              export $(cat .env | xargs)
            else
              echo "âš ï¸ No .env file found, skipping variable loading."
            fi

            # --------------------------------------------------------
            # Stop existing FastAPI process (if running)
            # --------------------------------------------------------
            echo "ðŸ›‘ Stopping existing FastAPI process..."
            pkill -f "python3 main.py" || true

            # --------------------------------------------------------
            # Start app in background using nohup
            # --------------------------------------------------------
            echo "ðŸš€ Starting FastAPI app with nohup..."
            nohup venv/bin/python3 main.py > app.log 2>&1 &

            echo "âœ… Deployment complete! Check app.log for details."
          EOF
